---
export const prerender = false

import Layout from "@layouts/Layout.astro";
import Products from "@components/Products.astro";
import { getNestedCatalog } from "@lib/stock_info.js";

let groupedByExactTag = {};
let hasError = false;
let errorMessage = '';

try {
  const catalog = await getNestedCatalog();

  // Validar que sea un objeto válido
  if (catalog && typeof catalog === 'object' && !Array.isArray(catalog)) {
    groupedByExactTag = catalog;
  } else if (Array.isArray(catalog) && catalog.length > 0) {
    // Si es un array, está vacío - mostrar error
    hasError = true;
    errorMessage = 'No se pudieron cargar los productos. Por favor, recarga.';
  } else {
    // Objeto vacío u otro error
    hasError = true;
    errorMessage = 'Error al conectar con la API. Por favor, recarga.';
  }
} catch (error) {
  hasError = true;
  errorMessage = 'Error al cargar los productos. Por favor, recarga.';
  console.error('Error en index.astro:', error);
}
---

<Layout title="Welcome to Roots Barefoot Budget Generator">
	<main class="container mx-auto w-full place-content-center">
		{hasError && (
			<div class="alert alert-error m-8">
				<span>{errorMessage}</span>
			</div>
		)}
		{!hasError && Object.keys(groupedByExactTag).length > 0 && (
			<Products products={groupedByExactTag}/>
		)}
		{!hasError && Object.keys(groupedByExactTag).length === 0 && (
			<div class="alert alert-warning m-8">
				<span>No se encontraron productos disponibles.</span>
			</div>
		)}
	</main>
</Layout>
